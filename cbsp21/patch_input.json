{
  "schema_version": "cbsp21_patch_manifest_v1",
  "patch_id": "CAT-0021",
  "title": "feat(analyzer): GlobalStateAnalyzer end-to-end — analyzer, signals, tests, golden fixtures",
  "intent": "Add GlobalStateAnalyzer detecting module-level mutable state (GST_MUTABLE_MODULE_001), mutable default arguments (GST_MUTABLE_DEFAULT_001), and global keyword usage (GST_GLOBAL_KEYWORD_001). Wired into scan pipeline via _DEFAULT_ANALYZERS. Translator aggregates all global_state findings into a single signal with per-rule counts. Schema relaxed to support analyzer-specific evidence.summary shapes. Two fixture repos added (global_state_hot, global_state_clean). 33 unit/integration tests cover AST detection, signal translation, API integration, negative cases, determinism, and path normalization.",
  "change_type": "code",
  "behavior_change": "compatible",
  "risk_level": "medium",
  "scope": {
    "paths_in_scope": [
      "src/code_audit/",
      "tests/",
      "schemas/",
      "code_audit/data/schemas/",
      "cbsp21/"
    ],
    "files_expected_to_change": [
      "src/code_audit/analyzers/global_state.py",
      "src/code_audit/api.py",
      "src/code_audit/insights/translator.py",
      "schemas/run_result.schema.json",
      "src/code_audit/data/schemas/run_result.schema.json",
      "code_audit/data/schemas/run_result.schema.json",
      "tests/test_global_state_analyzer.py",
      "tests/fixtures/repos/global_state_hot/src/app.py",
      "tests/fixtures/repos/global_state_clean/src/app.py",
      "tests/fixtures/expected/global_state_hot_run_result.json",
      "tests/fixtures/expected/global_state_clean_run_result.json",
      "cbsp21/patch_input.json"
    ],
    "out_of_scope_notes": "AnalyzerType.GLOBAL_STATE, _COPY_PREFIX, _TYPE_WEIGHT, _CATEGORY_PENALTY_CAP, and i18n/en/signals.json already had global_state entries — no changes needed. Golden fixtures for existing repos unchanged (none contain global state patterns). Existing parity tests pass without modification."
  },
  "diff_range": {
    "base": "main",
    "head": "working-tree"
  },
  "changed_files_count": 12,
  "changed_files_exact": [
    "src/code_audit/analyzers/global_state.py",
    "src/code_audit/api.py",
    "src/code_audit/insights/translator.py",
    "schemas/run_result.schema.json",
    "src/code_audit/data/schemas/run_result.schema.json",
    "code_audit/data/schemas/run_result.schema.json",
    "tests/test_global_state_analyzer.py",
    "tests/fixtures/repos/global_state_hot/src/app.py",
    "tests/fixtures/repos/global_state_clean/src/app.py",
    "tests/fixtures/expected/global_state_hot_run_result.json",
    "tests/fixtures/expected/global_state_clean_run_result.json",
    "cbsp21/patch_input.json"
  ],
  "diff_articulation": {
    "what_changed": [
      "src/code_audit/analyzers/global_state.py: NEW — GlobalStateAnalyzer implementing Analyzer protocol. AST-walks for 3 rules: GST_MUTABLE_MODULE_001 (module-level Assign/AnnAssign to mutable literals/constructors, severity=medium, confidence=0.85), GST_MUTABLE_DEFAULT_001 (function defaults/kw_defaults with mutable values, severity=high, confidence=0.92), GST_GLOBAL_KEYWORD_001 (global statements inside functions, severity=medium, confidence=0.80). Helpers: _is_mutable_literal, _is_mutable_constructor_call, _is_mutable_value, _target_name, _value_repr. Stable finding_id assignment: gst_{fingerprint[:8]}_{index}.",
      "src/code_audit/api.py: Added GlobalStateAnalyzer import. Added to _DEFAULT_ANALYZERS tuple (now 5 analyzers). CLI inherits automatically.",
      "src/code_audit/insights/translator.py: Added _signal_from_global_state() function aggregating all global_state findings into a single signal with mutable_default_count, module_mutable_count, global_keyword_count in evidence.summary. Evidence ordering: mutable defaults first, then module mutables, then global keyword. Main findings_to_signals() separates global_state from other findings; other findings still grouped by rule_id.",
      "schemas/run_result.schema.json + 2 copies: evidence.summary changed from additionalProperties:false with required:[swallowed_count,logged_count] to additionalProperties:true with no required fields. Added mutable_default_count, module_mutable_count, global_keyword_count property definitions. All 3 schema copies updated identically.",
      "tests/test_global_state_analyzer.py: NEW — 33 tests across 8 classes. TestModuleMutableDetected (7): empty list/dict, set/list/dict constructors, annotated assignment, multiple. TestMutableDefaultDetected (4): list/dict/set defaults, kwonly. TestGlobalKeywordDetected (2): single/multiple names. TestNonMutableNotFlagged (12): 7 immutable defaults (None/tuple/int/str/bool/frozenset/tuple_literal), 4 immutable module constants, 1 local mutable. TestFixtureRepos (4): hot detects all 3 patterns with exact counts, clean has 0 findings, stable IDs, posix paths. TestGlobalStateSignal (2): single aggregated signal, no signal when clean. TestAPIIntegration (2): scan_project includes by_type.global_state, clean has none.",
      "tests/fixtures/repos/global_state_hot/src/app.py: NEW — 3 module mutables (CACHE={}, NAMES=[], FLAGS=set()), 1 mutable default (seen=set()), 1 global keyword.",
      "tests/fixtures/repos/global_state_clean/src/app.py: NEW — immutable constants only (int, str, tuple), no mutable state.",
      "tests/fixtures/expected/global_state_hot_run_result.json: NEW — auto-generated golden fixture.",
      "tests/fixtures/expected/global_state_clean_run_result.json: NEW — auto-generated golden fixture."
    ],
    "why_not_redundant": "First analyzer for global state patterns. AnalyzerType.GLOBAL_STATE existed in enum but had no implementing analyzer. Translator, confidence, and i18n entries were pre-wired but dormant. This commit activates them end-to-end."
  },
  "verification": {
    "commands_run": [
      "python -m pytest tests/test_global_state_analyzer.py -v --tb=short",
      "python -m pytest tests/ -v --tb=short"
    ],
    "test_results": [
      "33 passed in 1.93s — all GlobalStateAnalyzer tests green",
      "509 collected, 506 passed, 3 skipped in 52.16s — full suite green, 0 regressions"
    ],
    "notes": "Test count: 463 → 506 (+33 new GlobalStateAnalyzer tests, +10 from golden fixtures auto-parametrizing over 2 new fixture repos). 3 skips are pre-existing scaffold tests. All existing parity/contract/golden tests pass unchanged. No signal_logic_version bump needed — existing fixture repos have no global state patterns."
  },
  "file_context_coverage_percent": 100
}
